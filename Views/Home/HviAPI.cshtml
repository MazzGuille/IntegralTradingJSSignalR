@{
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
}

@using IntegralTradingJS.Models;



@(
Html.DevExtreme().DataGrid<HVI>()
    .ID("bodyTable")
    .ShowBorders(true)
    .DataSource(d => d.Mvc().Controller("HVI").LoadAction("Get").Key("ID"))
    .Height(500)
    .FilterRow(f =>
    {
        f.Visible(true);

    })
    .HeaderFilter(f =>
    {
        f.Visible(true);
    }) 
    
    .ShowColumnLines(true)
    .ShowRowLines(true)
    .RowAlternationEnabled(true)
    .ShowBorders(true)
    .GroupPanel(p => p.Visible(true))
    .Sorting(sorting => sorting.Mode(GridSortingMode.None))
    .Grouping(g => g.AutoExpandAll(false))
    .RemoteOperations(false)
    .LoadPanel(loadPanel => loadPanel.Enabled(true))  
    .Scrolling(scrolling => scrolling.ColumnRenderingMode(GridColumnRenderingMode.Standard))
    .Paging(paging => paging.Enabled(false)) 
    .AllowColumnResizing(true)
    .ColumnAutoWidth(true)    
    .FocusedRowEnabled(true)
    .Editing(e =>
    {
        e.UseIcons(true);
    })
    .Columns(columns => {
        columns.Add()
        .Width(25)
        .Type(GridCommandColumnType.Buttons)
        .Buttons(b =>
        {
            b.Add()
            .Hint("Crear oferta")
            .Icon("money")
            .Visible(true)
            .OnClick("redirect");
        });
        columns.AddFor(m => m.ID);
        columns.AddFor(m => m.Status);
        columns.AddFor(m => m.Price);
        columns.AddFor(m => m.TipoPrecio);
        columns.AddFor(m => m.Almacen);
        columns.AddFor(m => m.Validez);
        columns.AddFor(m => m.TipoFecha);
        columns.AddFor(m => m.OfferDate);
        columns.AddFor(m => m.CropYear);
        columns.AddFor(m => m.Maturity);
        columns.AddFor(m => m.C1);
        columns.AddFor(m => m.C2);
        columns.AddFor(m => m.Leaf);
        columns.AddFor(m => m.Stpl);
        columns.AddFor(m => m.Mic);
        columns.AddFor(m => m.Str);
        columns.AddFor(m => m.LRR);       
        columns.AddFor(m => m.NetWeight);      
        columns.AddFor(m => m.Len);
        columns.AddFor(m => m.Ext);
        columns.AddFor(m => m.RD);
        columns.AddFor(m => m.PlusB);
        columns.AddFor(m => m.Uni);
        columns.AddFor(m => m.Trash);
        
    })    
  
   //activo, cancelado, con oferta, en cierre, vendido
)



@section Scripts{
    <script src="~/js/dist/browser/signalr.min.js"></script>
    <script>       

        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/hvihub")
            .build();

        $(function() {
            connection.start().then(function(){
                setInterval(() => {
                    connection.invoke("ExecuteProcedure")
                    .catch(function (err) {
                            return console.error(err.toString());
                    });
                }, 100000);

                connection.on("ReceiveStoredProcedureResult", function (result) {
                    var _store = [{
                        Id: null, Status: null, Price: null, WhseCode: null, WhseTag: null, C1: null, C2: null, Leaf: null, Stpl: null, Mic: null,
                        Str: null, LRR : null , CropYear: null, NetWeight: null, Comp: null, Len: null, Ext: null, RD: null,
                        PlusB: null, Uni : null , Trash: null, StorageDate: null 
                    }];

                    result.forEach(x => {
                        _store.push({
                            Id: x.id,
                            Status: x.status,
                            Price: x.price,
                            WhseCode: x.whseCode,
                            WhseTag: x.whseTag,
                            C1: x.c1,
                            C2: x.c2,
                            Leaf: x.leaf,
                            Stpl: x.stpl,
                            Mic: x.mic,
                            Str: x.str,
                            LRR: x.lrr,
                            CropYear: x.cropYear,
                            NetWeight: x.netWeight,
                            Comp: x.comp,
                            Len: x.len,
                            Ext: x.ext,
                            RD: x.rd,
                            PlusB: x.plusB,
                            Uni: x.uni,
                            Trash: x.trash,
                            StorageDate: x.storageDate
                        });
                    });               

                    $("#bodyTable").dxDataGrid({
                        dataSource: _store.shift()                        
                    });

                    
                    
                });
             });
        });

        function redirect(){
            window.location.href = '/Buyer/Index'
        }

    </script>
}


