
@{
    ViewData["Title"] = "OfferUpload";
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
}





<div class="row">
  <div class="col-12 d-flex justify-content-center align-items-center">
      <h2>Upload your offer</h2>
  </div>
</div>


    <div id="mainDiv" class="row">
        <div class="col-12">
            <div class="card">
                <div class="d-flex flex-row align-items-center justify-content-between card-header">
                    <div id="excel">1 de 3 - Cargar HVI </div>
                    <div>
                        <button id="mostrar" class="btn btn-primary text-white fw-bold visually-hidden" onclick="mostrarDatos()">Mostrar datos</button>
                        <button id="siguiente1" class="btn btn-primary text-white fw-bold visually-hidden" onclick="seguir1()">Siguiente</button>                                               
                    </div>
                </div>     
                
                <div class="card-body">

                 <div id="fileInput" class="col-sm-4">
                    <label id="labelInput" style="cursor:pointer;" class="pointer-event text-primary fw-bold" for="inputExcel"><span><i class="bi bi-file-earmark-arrow-up text-primary"></i></span> Seleccionar archivo</label>
                    <input class="form-control-file visually-hidden" type="file" id="inputExcel" onclick="mostrarBoton()" />
                 </div>  
                
                <hr id="mainHr" class="" />

                    <div class="row" style=" max-height:60vh; overflow:scroll;">
                        <div class="col-sm-12">
                            <table id="tbData" class="table table-striped table-condensed" style="min-width:max-content; border:1px solid black">
                                <thead>
                                    <tr style="position:sticky; top:0px; background-color:white; height:100%">
                                        <th>C1</th>
                                        <th>C2</th>
                                        <th>Leaf</th>
                                        <th>Stpl</th>
                                        <th>Mic</th>
                                        <th>Str</th>
                                        <th>LRR</th>
                                        <th>NetWeight</th>
                                        <th>Len</th>
                                        <th>Ext</th>
                                        <th>RD</th>
                                        <th>PlusB</th>
                                        <th>Uni</th>
                                        <th>Trash</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                </tbody>
                            </table>
                            <div id="loadingSpinner" class=" d-none text-center text-primary">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                    </div>              
                </div>
            </div>
        </div>
    </div>

    <div id="formDiv" class="row visually-hidden w-50 mx-auto">
       <div class="col-sm-12">
            <div class="card ">
                <div class="d-flex flex-row align-items-center justify-content-between card-header">
                    <div id="excel">2 de 3 - datos de la oferta </div>
                    <div>
                        <button id="siguiente2" class="btn btn-primary text-white fw-bold" onclick="seguir2(); return false;">Siguiente</button>
                    </div>
                </div>

                <div class="card-body">
                    
                            <form class="col-12 d-flex flex-column justify-content-between gap-1">
                                <div>
                                    <div class="form-group">
                                        @* <label class="fw-bold" for="priceInput">PRECIO</label>*@
                                        <input type="number" id="priceInput" class="form-control w-50" placeholder="PRECIO" />
                                      
                                            <input type="radio" id="fixPrice" name="priceType" value="Precio fijo">
                                            <label class="fw-bold" for="fixPrice">Precio fijo</label>

                                            <br />

                                            <input type="radio" id="marketPlusPrice" name="priceType" value="Mercado mas precio">
                                            <label class="fw-bold" for="marketPlusPrice">Mercado mas precio</label>                                                                       
                                        
                                    </div>

                                    <br />

                                    <div class="form-group">
                                        <label class="fw-bold" for="almacenInput">ALMACEN</label>
                                        <select id="almacenInput">
                                            <option value="Monterrey">Monterrey</option>
                                            <option value="DF">DF</option>
                                            <option value="Cancun">Cancun</option>
                                        </select>
                                    </div>

                                    <br />

                                    <div class="form-group">
                                        <label class="fw-bold" for="validezInput">VALIDEZ</label>
                                        <input type="date" id="validezInput" class="form-control w-50" />

                                        <input type="radio" id="fixDate" name="validityType" value="Fecha fija">
                                        <label class="fw-bold" for="fixDate">Fecha fija</label>

                                        <br />

                                        <input type="radio" id="GTC" name="validityType" value="GTC">
                                        <label class="fw-bold" for="GTC">GTC</label>
                                    </div>
                                </div>

                                <br />

                                <div>

                                    <div class="form-group">
                                        @*<label class="fw-bold" for="CropYearInput">AÑO DE COCECHA</label>*@
                                        <input type="number" id="CropYearInput" class="form-control w-50" placeholder="AÑO DE COCECHA" />
                                    </div>

                                    <br />

                                    <div class="form-group">
                                        @*<label class="fw-bold" for="MaturityInput">Madurez</label>*@
                                        <input type="text" id="MaturityInput" class="form-control w-50" placeholder="Madurez" />
                                    </div>
                                    <br />

                                </div>

                            </form>
                       
                </div>
            </div>
       </div>
    </div>

    <div id="uploadDiv" class="row visually-hidden  w-50 mx-auto">
        <div class="col-sm-12">
            <div class="card">
                <div class="d-flex flex-row align-items-center justify-content-between card-header">
                    <div id="excel">3 de 3 - Confirmacion de oferta</div>
                    <div>
                    <button id="siguiente3" class="btn btn-primary text-white fw-bold" onclick="mostrarPromedio()">Confirmar oferta</button>
                    <button id="enviardb" class="btn btn-primary text-white fw-bold visually-hidden" onclick="enviarBaseDatos()">Cargar oferta</button>
                    </div>
                </div>
            </div>
            <div class="card-body">    
                
                <div class="col-12 d-flex flex-column justify-content-between gap-1">
                     <input type="text" readonly id="priceReadOnly" class="w-50 form-control" placeholder="PRECIO" />

                     <input type="text" readonly id="priceTypeReadOnly" class="w-50 form-control" placeholder="PRECIO tipo">
        
                     <input type="text" readonly id="almacenReadOnly" class="w-50 form-control" placeholder="almacen">

                     <input type="text" readonly id="validezReadOnly" class="w-50 form-control" placeholder="validez" />

                     <input type="text" readonly id="validezTypeReadOnly" class="w-50 form-control" placeholder="validez type" />

                     <input type="text" readonly id="CropYearReadOnly" class="w-50 form-control" placeholder="AÑO DE COCECHA" />

                     <input type="text" readonly id="MaturityReadOnly" class="w-50 form-control" placeholder="Madurez" />
                </div>                 
                

                <div class="row">
                    <div class="col-sm-12">
                        <h3 id="xd" class="card-body">Promedio</h3>
                        <table id="tbAvg" class="table table-striped">
                            <thead class="bg-light">
                                <tr>
                                    <th>C1</th>
                                    <th>C2</th>
                                    <th>Leaf</th>
                                    <th>Stpl</th>
                                    <th>Mic</th>
                                    <th>Str</th>
                                    <th>LRR</th>
                                    <th>NetWeight</th>
                                    <th>Len</th>
                                    <th>Ext</th>
                                    <th>RD</th>
                                    <th>PlusB</th>
                                    <th>Uni</th>
                                    <th>Trash</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody2">
                            </tbody>
                        </table>
                    </div>
                  </div>

            </div>
       </div>       
    </div> 



@section Scripts{
    <script>
        const input = document.getElementById("inputExcel")
        const mostrar = document.getElementById("mostrar")
        const tableBody = document.getElementById("tableBody")
        const loadingSpinner = document.getElementById("loadingSpinner")
        const tbData = document.getElementById("tbData")
        const enviardb = document.getElementById("enviardb")
        const priceInput = document.getElementById("priceInput")
        const almacenInput = document.getElementById("almacenInput")
        const validezInput = document.getElementById("validezInput")
        const fixDate = document.getElementById("fixDate")
        const CropYearInput = document.getElementById("CropYearInput")
        const formDiv = document.getElementById("formDiv")
        const mainDiv = document.getElementById("mainDiv")
        const fileInput = document.getElementById("fileInput")
        const excel = document.getElementById("excel")
        const mainHr = document.getElementById("mainHr")
        const fixPrice = document.getElementById("fixPrice")
        const marketPlusPrice = document.getElementById("marketPlusPrice")
        const GTC = document.getElementById("GTC")
        const MaturityInput = document.getElementById("MaturityInput")
        const siguiente1 = document.getElementById("siguiente1")
        const siguiente2 = document.getElementById("siguiente2")
        const siguiente3 = document.getElementById("siguiente3")
        const uploadDiv = document.getElementById("uploadDiv")
        const priceReadOnly = document.getElementById("priceReadOnly")
        const almacenReadOnly = document.getElementById("almacenReadOnly")
        const validezReadOnly = document.getElementById("validezReadOnly")
        const CropYearReadOnly = document.getElementById("CropYearReadOnly")
        const MaturityReadOnly = document.getElementById("MaturityReadOnly")
        const priceTypeReadOnly = document.getElementById("priceTypeReadOnly")
        const validezTypeReadOnly = document.getElementById("validezTypeReadOnly")   
        let postData = {}

        function mostrarBoton() {
            mostrar.classList.remove('visually-hidden');
            input.addEventListener("change", function () {
            labelInput.innerHTML = input.files[0].name;
            });
        }

        function mostrarDatos() {

                loadingSpinner.classList.remove("d-none");

                const formData = new FormData()

                formData.append("ArchivoExcel", input.files[0])

                fetch("/Seller/MostrarDatos", {
                    method: "POST",
                    body: formData
                })
                    .then((response) => { return response.json() })
                    .then((dataJson) => {
                        dataJson.forEach((item) => {
                            $("#tbData tbody").append(
                                $("<tr>").append(
                                    $("<td>").text(item.C1),
                                    $("<td>").text(item.C2),
                                    $("<td>").text(item.Leaf),
                                    $("<td>").text(item.Stpl),
                                    $("<td>").text(item.Mic),
                                    $("<td>").text(item.Str),
                                    $("<td>").text(item.LRR),
                                    $("<td>").text(item.NetWeight),
                                    $("<td>").text(item.Len),
                                    $("<td>").text(item.Ext),
                                    $("<td>").text(item.RD),
                                    $("<td>").text(item.PlusB),
                                    $("<td>").text(item.Uni),
                                    $("<td>").text(item.Trash)
                                )
                            )
                        })                       
                        loadingSpinner.classList.add("d-none");
                        mostrar.classList.add("visually-hidden")
                        siguiente1.classList.remove("visually-hidden")
                    })                             
        }

        function seguir1(){
            mainHr.classList.add('visually-hidden')
            fileInput.classList.add('visually-hidden');
            excel.classList.add('visually-hidden');
            tbData.classList.add('visually-hidden');
            mainDiv.classList.add('visually-hidden');
            siguiente1.classList.add("visually-hidden")
            formDiv.classList.remove("visually-hidden")
        }

        function seguir2(){
            formDiv.classList.add("visually-hidden")
            uploadDiv.classList.remove("visually-hidden")

            priceReadOnly.value = priceInput.value
            priceTypeReadOnly.value = document.querySelector('input[name="priceType"]:checked').value
            almacenReadOnly.value = almacenInput.value
            validezReadOnly.value = validezInput.value
            validezTypeReadOnly.value = document.querySelector('input[name="validityType"]:checked').value
            CropYearReadOnly.value  = CropYearInput.value
            MaturityReadOnly.value = MaturityInput.value
        }

        function mostrarPromedio(){
            siguiente3.classList.add("visually-hidden")
            enviardb.classList.remove("visually-hidden")
            const table=document.getElementById("tableBody");
            const table2=document.getElementById("tableBody2");
            const rows=table.rows.length;
            const cols = 14;
            const proms = [];            
            var sumVal=0;

            for(var j = 0; j < cols; j++){
                for(var i = 0; i < rows; i++)
                {
                    sumVal = sumVal + parseFloat(table.rows[i].cells[j].innerHTML);
                }
                proms.push( parseFloat(sumVal / rows).toFixed(2));
                sumVal=0;
            }     

            var tableContent = '<tr>';
            for (var i = 0; i < cols; i++) {
                tableContent += "<td>" + proms[i] + "</td>";
            }

            tableContent += '</tr>';
            table2.innerHTML += tableContent;


            proms.push(priceReadOnly.value);
            proms.push(priceTypeReadOnly.value);
            proms.push(almacenReadOnly.value);
            proms.push(validezReadOnly.value);
            proms.push(validezTypeReadOnly.value);
            proms.push(CropYearReadOnly.value);
            proms.push(MaturityReadOnly.value);            


            postData = {values: proms};
            console.log(postData)
        }

        function enviarBaseDatos() {
          $.ajax({
              type: "POST",
                url: "/Seller/InsertData",
                data: postData,
                datatype: "json",
                traditional: true
          });
            window.location.href = '/Home/HviAPI'
        }

         //function insertData(){
         //     //IntegralTradingJS.IntegralTradingJS.Repository.InsertData(600,339712,967369,3,52,4,37,48,273,4595,2019,510,'GU',113,31,705,71,823,6,1988-01-22);

         //   $.ajax({
         //   type: 'POST',
         //   // Note the difference in url (this works if you're actually in Index page)
         //   url: 'C:\Users\chooe\Documents\GitHub\IntegralTradingJSSignalR\Repository\HviService.cs\InsertData()',
         //   data: "{600,339712,967369,3,52,4,37,48,273,4595,2019,510,'GU',113,31,705,71,823,6,1988-01-22}",
         //   contentType: "application/json; charset=utf-8", 
         //   dataType: "json",
         //   success: function (data) {
         //     alert(data);
         //   },
         //   error: function (error) {
         //     alert("Error: " + error);
         //   }
         //   })
         //}

         //function insertData2(){
         //   var mysql = require('mysql');

         //   var con = mysql.createConnection({
         //     host: "104.214.62.172",
         //     user: "UserIntegralCottonQA",
         //     password: "90/-.54S4Dsas##",
         //     database: "IntegralCotton_dbQA"
         //   });

         //   con.connect(function(err) {
         //     if (err) throw err;
         //     console.log("Connected!");
         //     var sql = "INSERT INTO Matriz VALUES (1000,NULL,NULL,NULL,NULL,222501739,NULL,NULL,NULL,NULL,NULL,NULL,1.28,84,30,8.5,6.5,NULL,NULL,4.3,75.5,8.2,'41-2',NULL,NULL,1,NULL);";
         //     con.query(sql, function (err, result) {
         //       if (err) throw err;
         //       console.log("1 record inserted");
         //     });
         //   });
         //}
        
    </script>
}